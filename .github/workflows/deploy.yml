name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '>=1.24.0'
        cache: true

    - name: Generate Build Metadata
      run: |
        echo VERSION=`git describe --tags --always --dirty` >> $GITHUB_ENV
        echo COMMIT=`git rev-parse --short HEAD` >> $GITHUB_ENV
        echo BUILD_DATE=`date -u +%Y-%m-%dT%H:%M:%SZ` >> $GITHUB_ENV

    - name: Build Linux Binary
      run: |
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
          -ldflags="-s -w -X 'main.Version=${{ env.VERSION }}' -X 'main.Commit=${{ env.COMMIT }}' -X 'main.BuildDate=${{ env.BUILD_DATE }}'" \
          -o CLIProxyAPI ./cmd/server/

    - name: Upload Binary
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        source: "CLIProxyAPI"
        target: "/tmp/"

    - name: Execute Deployment Script
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
          if [ -f "/opt/cliproxy/deploy.sh" ]; then
            sudo /opt/cliproxy/deploy.sh
          else
            echo "âŒ éƒ¨ç½²è„šæœ¬ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œè¿ç§»è„šæœ¬"
            exit 1
          fi

          # éªŒè¯éƒ¨ç½²ç»“æœ
          echo "=== éªŒè¯éƒ¨ç½²ç»“æœ ==="
          if sudo systemctl is-active --quiet cliproxy; then
            echo "âœ… æœåŠ¡è¿è¡Œæ­£å¸¸"
            sudo systemctl status cliproxy --no-pager -l

            # æ£€æŸ¥ç«¯å£ç›‘å¬
            echo "=== æ£€æŸ¥ç«¯å£ç›‘å¬ ==="
            sudo netstat -tlnp | grep -E "(8317|8085|1455|54545|51121|11451)" || echo "ç«¯å£æ£€æŸ¥å®Œæˆ"

            # æµ‹è¯• API å“åº”
            echo "=== æµ‹è¯• API å“åº” ==="
            curl -I http://localhost:8317 || echo "API æµ‹è¯•å®Œæˆ"

            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          else
            echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
            sudo journalctl -u cliproxy --no-pager -l -n 20
            exit 1
          fi
